# 要件定義書

## 概要

OCR Web APIは、日本の身分証明書画像から構造化データを抽出するRESTfulサービスです。運転免許証と個人番号カード（マイナンバーカード）の画像をアップロードし、光学文字認識を実行して主要な個人情報フィールドを抽出します。このサービスは、身元確認や個人情報収集を必要とするアプリケーションのデータ入力プロセスを自動化することを目的としています。

## 要件

### 要件1

**ユーザーストーリー:** クライアントアプリケーション開発者として、REST API経由で身分証明書画像を送信し、手動データ入力なしで個人情報を自動抽出したい。

#### 受入基準

1. クライアントが有効なJSONペイロードで/ocrエンドポイントにPOSTリクエストを送信した時、システムはリクエストを受け入れHTTP 200ステータスを返すこと
2. リクエストにbase64エンコードされた画像と文書タイプが含まれている時、システムは画像をデコードして処理すること
3. JSONペイロードが不正な形式の場合、システムはエラー詳細とともにHTTP 400を返すこと
4. 画像が10MBのサイズ制限を超えた時、システムはサイズ制限エラーとともにHTTP 422を返すこと

### 要件2

**ユーザーストーリー:** クライアントアプリケーションとして、処理する文書タイプを指定し、異なる身分証明書に適切な解析ルールを適用したい。

#### 受入基準

1. 文書タイプが"drivers_license_jp"の時、システムは日本の運転免許証解析ルールを使用すること
2. 文書タイプが"individual_number_card_jp"の時、システムは個人番号カード解析ルールを使用すること
3. サポートされていない文書タイプが提供された場合、システムはサポート外文書タイプエラーとともにHTTP 422を返すこと
4. リクエストから文書タイプが欠落している時、システムは必須フィールド欠落エラーとともにHTTP 400を返すこと

### 要件3

**ユーザーストーリー:** クライアントアプリケーションとして、抽出されたデータを構造化されたJSON形式で受信し、アプリケーションのデータモデルに簡単に統合したい。

#### 受入基準

1. OCR処理が成功した時、システムは文書タイプと抽出されたデータフィールドを含むJSONレスポンスを返すこと
2. 日本の運転免許証を処理する時、システムは氏名、住所、生年月日、免許証番号、交付年月日、有効期限フィールドを抽出すること
3. 個人番号カードを処理する時、システムは氏名、住所、生年月日、性別、個人番号、交付年月日、有効期限フィールドを抽出すること
4. フィールドが抽出できない場合、システムはレスポンスに空文字列値でフィールドを含めること

### 要件4

**ユーザーストーリー:** クライアントアプリケーションとして、処理が失敗した時に適切なエラーレスポンスを受信し、異なる失敗シナリオを適切に処理したい。

#### 受入基準

1. 画像がデコードできない時、システムは画像デコードエラーとともにHTTP 422を返すこと
2. OCR処理が失敗した時、システムはOCR処理エラーとともにHTTP 422を返すこと
3. システムが内部エラーに遭遇した時、システムは汎用エラーメッセージとともにHTTP 500を返すこと
4. エラーが発生した時、システムはJSONレスポンスにエラーコードと説明メッセージを含めること

### 要件5

**ユーザーストーリー:** システム管理者として、APIが複数の同時リクエストを効率的に処理し、本番ワークロードをサポートしたい。

#### 受入基準

1. 複数のリクエストが同時に受信された時、システムはブロックすることなく並行して処理すること
2. リクエスト処理が30秒を超えた時、システムはタイムアウトしHTTP 408を返すこと
3. システムリソースが適切に管理されている時、OpenCVマトリックスは処理後に解放されること
4. Tesseractクライアントが再利用される時、システムは効率性のためクライアントプールを維持すること

### 要件6

**ユーザーストーリー:** クライアントアプリケーションとして、一般的な形式で画像を送信し、フォーマット変換なしで様々な画像ソースと統合したい。

#### 受入基準

1. 画像がPNG形式の時、システムは正常にデコードして処理すること
2. 画像がJPEG形式の時、システムは正常にデコードして処理すること
3. 画像がサポートされていない形式の時、システムはサポート外形式エラーとともにHTTP 422を返すこと
4. 画像データが有効なbase64でない時、システムは無効なエンコーディングエラーとともにHTTP 400を返すこと

### 要件7

**ユーザーストーリー:** 開発者として、包括的なログ記録と監視機能により、問題のトラブルシューティングとシステムパフォーマンスの監視を行いたい。

#### 受入基準

1. リクエストが処理された時、システムはリクエスト詳細と処理時間をログに記録すること
2. エラーが発生した時、システムは適切なログレベルでエラー詳細をログに記録すること
3. システムが開始された時、システムは設定と初期化ステータスをログに記録すること
4. ログレベルが設定されている場合、システムはDEBUG、INFO、WARN、ERRORレベルを尊重すること